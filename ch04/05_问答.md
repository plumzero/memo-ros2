
### ROS2 架构

|    层级    |    组件   | 说明 |
|:----------|:----------| :--- |
| OS/网络层  | Linux, Windows, macOS, RTOS | ROS2 支持多操作系统，甚至实时操作系统 |
| DDS 实现层 | Cyclone DDS, Fast DDS, RTI Connext | 提供符合 DDS 标准的实际通信能力 |
| RMW 接口层 | `rmw` 接口 | 定义统一的 API 将 ROS2 核心与特定的 DDS 实现解耦，不同的 DDS 通过实现`rmw`接口来接入 ROS2 |
| ROS 客户端库层 | rclcpp(C++), rclpy(Python) | ROS2核心库。封装了`rmw`接口，提供了所有 ROS 概念(节点、话题、服务等)的逻辑实现 |
| ROS 接口定义层 | 消息(`.msg`), 服务(`.srv`), 动作(`.action`) | 通过 IDL 定义通信的数据结构 |
| 应用层 | 应用节点 | 功能节点或功能包 |

### 执行模型与线程

ROS2 引入了更灵活、可控的执行模型:
- 执行器: 负责从节点中取出回调(消息、服务、定时器)并执行。
- 单线程执行器: 所有回调在一个线程中顺序执行。
- 多线程执行器: 回调在一个线程池中执行，提高并发性。
- 自定义执行器: 用户可以精细控制回调的执行方式和时机。

回调组:
- 可重入组: 回调可以并行执行，适用于无状态操作。
- 互斥组: 组内回调互斥执行，保证线程安全。

### ROS2 是怎样实现域隔离的

在 DDS 标准中，域(Domain)是一个逻辑网络分区，只有共享相同`域ID`(Domain ID)的节点才能相互通信。ROS2 直接利用了 DDS 的这一特性来实现隔离。

DDS 根据 DomainId 划分不同的组播组，域的参与者根据 DomainId 加入对应的组播中。DDS 就是通过`组播地址`和`端口号`的映射来实现域隔离的。

### ROS2 的服务发现过程

ROS2 的服务发现是一个多阶段的过程，完全由 DDS 的 RTPS 协议驱动。一般包括 4 个阶段。

阶段一: 参与者发现(Participant Discovery)
- 机制: 通过组播(默认 239.255.0.1：7401)定期发送(默认每 3 秒一次)SPDP 消息，超时未收到则认为节点离线
- 信息交换: DomainParticipant GUID、网络位置(IP: Port)
- 结果: 节点知道同一域中有哪些其他节点

阶段二: 端点发现(Endpoint Discovery)
- 机制: 通过单播(使用 SPDP 获得的地址)交换端点(发布者 DataWriter 或订阅者 DataReader)信息
- 信息交换:
  - DataWriter: 发布的话题名、数据类型、QoS
  - DataReader: 订阅的话题名、数据类型、QoS
- 结果: 节点知道谁发布/订阅什么话题

阶段三: 匹配验证(Matching Validation)
- 验证内容(检查发布者和订阅者是否兼容):
  - 话题名是否完全匹配
  - 数据类型是否相同(包括包名)
  - QoS 策略是否兼容(如可靠性、持久性等)
- 结果: 建立匹配对，准备建立连接

阶段四: 连接建立(Connection Establishment)
- 机制: 交换网络位置信息，建立直接的 UDP/TCP 连接
- 结果: 开始实际的数据传输

时间线流程如下:
```s
时间点    listener                          talker
--------------------------------------------------------------------
t=0s     启动，创建DomainParticipant
         ↓ 发送SPDP(组播:239.255.0.1:7401)
         "我是参与者 GUID_PREFIX_1，单播地址 192.168.1.100:7400"
         
t=1s                                启动，创建DomainParticipant
                                    ↓ 发送SPDP(组播)
                                    "我是参与者 GUID_PREFIX_2，单播地址 192.168.1.101:7650"
         
t=1.1s   收到talker的SPDP消息
         ↓ 建立单播连接到 192.168.1.101:7650
         ↓ 通过SEDP交换端点信息
         "我订阅 /chatter，类型 std_msgs/String，QoS:可靠"
         
t=1.2s                               收到listener的SPDP消息
                                    ↓ 建立单播连接到 192.168.1.100:7400
                                    ↓ 通过SEDP交换端点信息
                                    "我发布 /chatter，类型 std_msgs/String，QoS:可靠"
         
t=1.3s   发现匹配！QoS兼容
         ↓ 发送订阅确认
         ↓ 建立数据传输连接(动态端口，如 49200)
         
t=1.4s                               收到匹配确认
                                    ↓ 建立数据传输连接
         
t=1.5s                               开始发送数据到 192.168.1.100:49200
         
t=1.6s   在端口 49200 收到数据，开始处理
```

### ROS2 是如何保证 Reliable 的

ROS2 可靠性保证基于 DDS 标准的 Reliability QoS 协议，它是一个基于`序列号+ACK/NACK`的可靠协议。包含的内容有:
- 序列号: 每个数据包唯一标识
- 确认机制: ACK(确认)、NACK(否定确认)
- 重传机制: 基于定时器的重传
- 流控制: 窗口大小控制
